<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Chloneda</title>
    <link>https://chloneda.github.io/</link>
    <atom:link href="/rss2.html" rel="self" type="application/rss+xml"/>
    
    <description>Less is more</description>
    <pubDate>Sat, 16 Mar 2019 16:05:47 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>深入浅出Mybatis系列十-SQL执行流程分析（源码篇）</title>
      <link>https://chloneda.github.io//blog/mybatis-10/</link>
      <guid>https://chloneda.github.io//blog/mybatis-10/</guid>
      <pubDate>Sat, 16 Mar 2019 16:05:47 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;注：本文转载自&lt;a href=&quot;https://www.cnblogs.com/dongying/p/4142476.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;南轲梦&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最近太忙了，一直没时间继续更新博客，今天忙里偷闲继续
        
      
      </description>
      
      <content:encoded><![CDATA[<p>注：本文转载自<a href="https://www.cnblogs.com/dongying/p/4142476.html" target="_blank" rel="noopener">南轲梦</a></p><p>最近太忙了，一直没时间继续更新博客，今天忙里偷闲继续我的Mybatis学习之旅。在前九篇中，介绍了mybatis的配置以及使用， 那么本篇将走进mybatis的源码，分析mybatis 的执行流程， 好啦，鄙人不喜欢口水话，还是直接上干活吧：</p><h1 id="SqlSessionFactory-与-SqlSession"><a href="#SqlSessionFactory-与-SqlSession" class="headerlink" title="SqlSessionFactory 与 SqlSession"></a>SqlSessionFactory 与 SqlSession</h1><p>通过前面的章节对于mybatis 的介绍及使用，大家都能体会到SqlSession的重要性了吧， 没错，从表面上来看，咱们都是通过SqlSession去执行sql语句（注意：是从表面看，实际的待会儿就会讲）。那么咱们就先看看是怎么获取SqlSession的吧：</p><p><img src="https://chloneda.github.io/uploads/SqlSessionFactory.png" alt="SqlSessionFactory"></p><p>首先，SqlSessionFactoryBuilder去读取mybatis的配置文件，然后build一个DefaultSqlSessionFactory。源码如下：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 一系列的构造方法最终都会调用本方法（配置文件为Reader时会调用本方法，还有一个InputStream方法与此对应）</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> reader</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> environment</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> properties</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function">SqlSessionFactory <span class="title">build</span><span class="params">(Reader reader, String environment, Properties properties)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//通过XMLConfigBuilder解析配置文件，解析的配置相关信息都会封装为一个Configuration对象</span></span><br><span class="line">      XMLConfigBuilder parser = <span class="keyword">new</span> XMLConfigBuilder(reader, environment, properties);</span><br><span class="line">      <span class="comment">//这儿创建DefaultSessionFactory对象</span></span><br><span class="line">      <span class="keyword">return</span> build(parser.parse());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error building SqlSession."</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        reader.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// Intentionally ignore. Prefer previous error.</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function">SqlSessionFactory <span class="title">build</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSessionFactory(config);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>当我们获取到SqlSessionFactory之后，就可以通过SqlSessionFactory去获取SqlSession对象。源码如下：<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通常一系列openSession方法最终都会调用本方法</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> execType </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> level</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> autoCommit</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit) &#123;</span><br><span class="line">    Transaction tx = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//通过Confuguration对象去获取Mybatis相关配置信息, Environment对象包含了数据源和事务的配置</span></span><br><span class="line">      <span class="keyword">final</span> Environment environment = configuration.getEnvironment();</span><br><span class="line">      <span class="keyword">final</span> TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">      <span class="comment">//之前说了，从表面上来看，咱们是用sqlSession在执行sql语句， 实际呢，其实是通过excutor执行， excutor是对于Statement的封装</span></span><br><span class="line">      <span class="keyword">final</span> Executor executor = configuration.newExecutor(tx, execType);</span><br><span class="line">      <span class="comment">//关键看这儿，创建了一个DefaultSqlSession对象</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> e) &#123;</span><br><span class="line">      closeTransaction(tx); <span class="comment">// may have fetched a connection so lets call close()</span></span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error opening session.  Cause: "</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>通过以上步骤，咱们已经得到SqlSession对象了。接下来就是该干嘛干嘛去了（话说还能干嘛，当然是执行sql语句咯）。看了上面，咱们也回想一下之前写的Demo,<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SqlSessionFactory</span> sessionFactory = null;  </span><br><span class="line"><span class="type">String</span> resource = <span class="string">"mybatis-conf.xml"</span>;  </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">//SqlSessionFactoryBuilder读取配置文件</span></span><br><span class="line">    sessionFactory = <span class="function"><span class="keyword">new</span> <span class="title">SqlSessionFactoryBuilder</span>().<span class="title">build</span>(<span class="type">Resources</span>  </span></span><br><span class="line"><span class="function">              .getResourceAsReader(resource));</span></span><br><span class="line"><span class="function">&#125; <span class="title">catch</span> (<span class="type">IOException</span> e) &#123;  </span></span><br><span class="line"><span class="function">    <span class="title">e</span>.<span class="title">printStackTrace</span>();  </span></span><br><span class="line"><span class="function">&#125;    </span></span><br><span class="line"><span class="function"><span class="comment">//通过SqlSessionFactory获取SqlSession</span></span></span><br><span class="line"><span class="function"><span class="title">SqlSession</span> <span class="title">sqlSession</span> = <span class="title">sessionFactory</span>.<span class="title">openSession</span>();</span></span><br></pre></td></tr></table></figure></p><p>还真这么一回事儿，对吧！ </p><p>SqlSession咱们也拿到了，咱们可以调用SqlSession中一系列的select…,  insert…, update…, delete…方法轻松自如的进行CRUD操作了。 就这样？ 那咱配置的映射文件去哪儿了？  别急， 咱们接着往下看：</p><h1 id="利器之MapperProxy"><a href="#利器之MapperProxy" class="headerlink" title="利器之MapperProxy"></a>利器之MapperProxy</h1><p>在mybatis中，通过MapperProxy动态代理咱们的dao， 也就是说， 当咱们执行自己写的dao里面的方法的时候，其实是对应的mapperProxy在代理。那么，咱们就看看怎么获取MapperProxy对象吧：</p><p><img src="https://chloneda.github.io/uploads/MapperProxy.png" alt="MapperProxy"></p><p>通过SqlSession从Configuration中获取。源码如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 什么都不做，直接去configuration中找， 哥就是这么任性</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  public &lt;<span class="type">T</span>&gt; <span class="type">T</span> getMapper(<span class="type">Class</span>&lt;<span class="type">T</span>&gt; <span class="class"><span class="keyword">type</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> configuration.&lt;<span class="type">T</span>&gt;getMapper(<span class="class"><span class="keyword">type</span>, <span class="title">this</span>)</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>SqlSession把包袱甩给了Configuration, 接下来就看看Configuration。源码如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 烫手的山芋，俺不要，你找mapperRegistry去要</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> sqlSession</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; T getMapper(<span class="class"><span class="keyword">Class</span>&lt;<span class="title">T</span>&gt; <span class="title">type</span>, <span class="title">SqlSession</span> <span class="title">sqlSession</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mapperRegistry.getMapper(type, sqlSession);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>Configuration不要这烫手的山芋，接着甩给了MapperRegistry， 那咱看看MapperRegistry。 源码如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 烂活净让我来做了，没法了，下面没人了，我不做谁来做</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> sqlSession</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  @SuppressWarnings(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; T getMapper(<span class="class"><span class="keyword">Class</span>&lt;<span class="title">T</span>&gt; <span class="title">type</span>, <span class="title">SqlSession</span> <span class="title">sqlSession</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//能偷懒的就偷懒，俺把粗活交给MapperProxyFactory去做</span></span><br><span class="line">    <span class="keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (mapperProxyFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is not known to the MapperRegistry."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//关键在这儿</span></span><br><span class="line">      <span class="keyword">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Error getting mapper instance. Cause: "</span> + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>MapperProxyFactory是个苦B的人，粗活最终交给它去做了。咱们看看源码：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 别人虐我千百遍，我待别人如初恋</span></span><br><span class="line"><span class="comment">   * @param mapperProxy</span></span><br><span class="line"><span class="comment">   * @return</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  @SuppressWarnings(<span class="string">"unchecked"</span>)</span><br><span class="line">  protected T <span class="keyword">new</span><span class="type">Instance</span>(MapperProxy&lt;T&gt; mapperProxy) &#123;</span><br><span class="line">    <span class="comment">//动态代理我们写的dao接口</span></span><br><span class="line">    <span class="keyword">return</span> (T) Proxy.<span class="keyword">new</span><span class="type">ProxyInstance</span>(mapperInterface.getClassLoader(), <span class="keyword">new</span> <span class="type">Class</span>[] &#123; mapperInterface &#125;, mapperProxy);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> T <span class="keyword">new</span><span class="type">Instance</span>(SqlSession sqlSession) &#123;</span><br><span class="line">    final MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> <span class="type">MapperProxy</span>&lt;T&gt;(sqlSession, mapperInterface, methodCache);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span><span class="type">Instance</span>(mapperProxy);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>通过以上的动态代理，咱们就可以方便地使用dao接口啦， 就像之前咱们写的demo那样：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UserDao userMapper = sqlSession.getMapper(UserDao.class);  </span><br><span class="line">User insertUser = new User();</span><br></pre></td></tr></table></figure></p><p>这下方便多了吧， 呵呵， 貌似mybatis的源码就这么一回事儿啊。</p><p>别急，还没完， 咱们还没看具体是怎么执行sql语句的呢。</p><h1 id="Excutor"><a href="#Excutor" class="headerlink" title="Excutor"></a>Excutor</h1><p><img src="https://chloneda.github.io/uploads/Excutor.png" alt="Excutor"></p><p>接下来，咱们才要真正去看sql的执行过程了。</p><p>上面，咱们拿到了MapperProxy, 每个MapperProxy对应一个dao接口， 那么咱们在使用的时候，MapperProxy是怎么做的呢？ 源码奉上：</p><h1 id="MapperProxy源码"><a href="#MapperProxy源码" class="headerlink" title="MapperProxy源码"></a>MapperProxy源码</h1><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * MapperProxy在执行时会触发此方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  @Override</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">Object</span> invoke(<span class="keyword">Object</span> proxy, Method method, <span class="keyword">Object</span>[] args) <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">Object</span>.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">    <span class="comment">//二话不说，主要交给MapperMethod自己去管</span></span><br><span class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h1 id="MapperMethod源码"><a href="#MapperMethod源码" class="headerlink" title="MapperMethod源码"></a>MapperMethod源码</h1><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 看着代码不少，不过其实就是先判断CRUD类型，然后根据类型去选择到底执行sqlSession中的哪个方法，绕了一圈，又转回sqlSession了</span></span><br><span class="line"><span class="comment">   * @param sqlSession</span></span><br><span class="line"><span class="comment">   * @param args</span></span><br><span class="line"><span class="comment">   * @return</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public Object execute(SqlSession sqlSession, Object[] <span class="built_in">args</span>) &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    <span class="keyword">if</span> (SqlCommandType.INSERT == command.getType()) &#123;</span><br><span class="line">      Object param = <span class="built_in">method</span>.convertArgsToSqlCommandParam(<span class="built_in">args</span>);</span><br><span class="line">      result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SqlCommandType.UPDATE == command.getType()) &#123;</span><br><span class="line">      Object param = <span class="built_in">method</span>.convertArgsToSqlCommandParam(<span class="built_in">args</span>);</span><br><span class="line">      result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SqlCommandType.DELETE == command.getType()) &#123;</span><br><span class="line">      Object param = <span class="built_in">method</span>.convertArgsToSqlCommandParam(<span class="built_in">args</span>);</span><br><span class="line">      result = rowCountResult(sqlSession.<span class="built_in">delete</span>(command.getName(), param));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SqlCommandType.SELECT == command.getType()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">method</span>.returnsVoid() &amp;&amp; <span class="built_in">method</span>.hasResultHandler()) &#123;</span><br><span class="line">        executeWithResultHandler(sqlSession, <span class="built_in">args</span>);</span><br><span class="line">        result = null;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">method</span>.returnsMany()) &#123;</span><br><span class="line">        result = executeForMany(sqlSession, <span class="built_in">args</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">method</span>.returnsMap()) &#123;</span><br><span class="line">        result = executeForMap(sqlSession, <span class="built_in">args</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Object param = <span class="built_in">method</span>.convertArgsToSqlCommandParam(<span class="built_in">args</span>);</span><br><span class="line">        result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">throw</span> <span class="built_in">new</span> BindingException(<span class="string">"Unknown execution method for: "</span> + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (result == null &amp;&amp; <span class="built_in">method</span>.getReturnType().isPrimitive() &amp;&amp; !<span class="built_in">method</span>.returnsVoid()) &#123;</span><br><span class="line">      <span class="built_in">throw</span> <span class="built_in">new</span> BindingException(<span class="string">"Mapper method '"</span> + command.getName() </span><br><span class="line">          + <span class="string">" attempted to return null from a method with a primitive return type ("</span> + <span class="built_in">method</span>.getReturnType() + <span class="string">")."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> result;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>既然又回到SqlSession了， 那么咱们就看看SqlSession的CRUD方法了，为了省事，还是就选择其中的一个方法来做分析吧。这儿，咱们选择了selectList方法：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public &lt;E&gt; <span class="built_in">List</span>&lt;E&gt; selectList(<span class="built_in">String</span> statement, <span class="built_in">Object</span> parameter, RowBounds rowBounds) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      MappedStatement ms = configuration.getMappedStatement(statement);</span><br><span class="line">      <span class="comment">//CRUD实际上是交给Excetor去处理， excutor其实也只是穿了个马甲而已，小样，别以为穿个马甲我就不认识你嘞！</span></span><br><span class="line">      <span class="keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error querying database.  Cause: "</span> + e, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>然后，通过一层一层的调用，最终会来到doQuery方法， 这儿咱们就随便找个Excutor看看doQuery方法的实现吧，我这儿选择了SimpleExecutor:</p><h1 id="SimpleExecutor"><a href="#SimpleExecutor" class="headerlink" title="SimpleExecutor"></a>SimpleExecutor</h1><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; List&lt;E&gt; doQuery(MappedStatement ms</span><br><span class="line">, Object parameter</span><br><span class="line">, RowBounds rowBounds</span><br><span class="line">, ResultHandler resultHandler</span><br><span class="line">, BoundSql boundSql) <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Configuration configuration = ms.getConfiguration();</span><br><span class="line">      StatementHandler <span class="keyword">handler</span> = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">      stmt = prepareStatement(<span class="keyword">handler</span>, ms.getStatementLog());</span><br><span class="line">      <span class="comment">//StatementHandler封装了Statement, 让 StatementHandler 去处理</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">handler</span>.&lt;E&gt;query(stmt, resultHandler);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来，咱们看看StatementHandler 的一个实现类 PreparedStatementHandler（这也是我们最常用的，封装的是PreparedStatement）, 看看它使怎么去处理的：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="params">&lt;E&gt;</span> List<span class="params">&lt;E&gt;</span> query(Statement statement, ResultHandler resultHandler) throws <span class="class">SQLException </span>&#123;</span><br><span class="line">     <span class="comment">//到此，原形毕露， PreparedStatement, 这个大家都已经滚瓜烂熟了吧</span></span><br><span class="line">    PreparedStatement ps = (PreparedStatement) statement;</span><br><span class="line">    ps.execute();</span><br><span class="line">    <span class="comment">//结果交给了ResultSetHandler 去处理</span></span><br><span class="line">    return resultSetHandler.<span class="params">&lt;E&gt;</span> handleResultSets(ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>到此， 一次sql的执行流程就完了。 我这儿仅抛砖引玉，建议有兴趣的去看看Mybatis3的源码。</p><p>好啦，本次就到此结束啦</p><hr>]]></content:encoded>
      
      
    </item>
    
    <item>
      <title>深入浅出Mybatis系列九-强大的动态SQL</title>
      <link>https://chloneda.github.io//blog/mybatis-9/</link>
      <guid>https://chloneda.github.io//blog/mybatis-9/</guid>
      <pubDate>Sat, 16 Mar 2019 15:25:04 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;注：本文转载自&lt;a href=&quot;https://www.cnblogs.com/dongying/p/4092662.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;南轲梦&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上篇文章《深入浅出Mybatis系列（八）—mapp
        
      
      </description>
      
      <content:encoded><![CDATA[<p>注：本文转载自<a href="https://www.cnblogs.com/dongying/p/4092662.html" target="_blank" rel="noopener">南轲梦</a></p><p>上篇文章《深入浅出Mybatis系列（八）—mapper映射文件配置之select、resultMap》简单介绍了mybatis的查询，至此，CRUD都已讲完。本文将介绍mybatis强大的动态SQL。</p><p>那么，问题来了： 什么是动态SQL? 动态SQL有什么作用？</p><p>传统的使用JDBC的方法，相信大家在组合复杂的的SQL语句的时候，需要去拼接，稍不注意哪怕少了个空格，都会导致错误。Mybatis的动态SQL功能正是为了解决这种问题， 其通过 if, choose, when, otherwise, trim, where, set, foreach标签，可组合成非常灵活的SQL语句，从而提高开发人员的效率。下面就去感受Mybatis动态SQL的魅力吧：</p><h1 id="mybatis中if判断"><a href="#mybatis中if判断" class="headerlink" title="mybatis中if判断"></a>mybatis中if判断</h1><p>作为程序猿，谁不懂if　!在mybatis中也能用 if 啦：<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">select</span> id=<span class="string">"findUserById"</span> resultType=<span class="string">"user"</span>&gt;</span><br><span class="line">           <span class="keyword">select</span> * <span class="keyword">from</span> user <span class="keyword">where</span> </span><br><span class="line">           &lt;<span class="keyword">if</span> test=<span class="string">"id != null"</span>&gt;</span><br><span class="line">               id=<span class="meta">#&#123;id&#125;</span></span><br><span class="line">           &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            <span class="keyword">and</span> deleteFlag=<span class="number">0</span>;</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure></p><p>上面例子： 如果传入的id 不为空， 那么才会SQL才拼接id = #{id}。 这个相信大家看一样就能明白，不多说。</p><p>细心的人会发现一个问题：“你这不对啊！ 要是你传入的id为null,  那么你这最终的SQL语句不就成了 select * from user where and deleteFlag=0,  这语句有问题！”</p><p>是啊，这时候，mybatis的 where 标签就该隆重登场啦：</p><h1 id="mybatis中where"><a href="#mybatis中where" class="headerlink" title="mybatis中where"></a>mybatis中where</h1><p>咱们通过where改造一下上面的例子：<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">select</span> id=<span class="string">"findUserById"</span> resultType=<span class="string">"user"</span>&gt;</span><br><span class="line">           <span class="keyword">select</span> * <span class="keyword">from</span> user </span><br><span class="line">           &lt;<span class="keyword">where</span>&gt;</span><br><span class="line">               &lt;<span class="keyword">if</span> test=<span class="string">"id != null"</span>&gt;</span><br><span class="line">                   id=<span class="meta">#&#123;id&#125;</span></span><br><span class="line">               &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">               <span class="keyword">and</span> deleteFlag=<span class="number">0</span>;</span><br><span class="line">           &lt;/<span class="keyword">where</span>&gt;</span><br><span class="line"> &lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure></p><p>有些人就要问了： “你这都是些什么玩意儿！ 跟上面的相比， 不就是多了个where标签嘛！ 那这个还会不会出现  select * from user where and deleteFlag=0 ？”</p><p>的确，从表面上来看，就是多了个where标签而已， 不过实质上， mybatis是对它做了处理，当它遇到AND或者OR这些，它知道怎么处理。其实我们可以通过 trim 标签去自定义这种处理规则。</p><h1 id="trim-我的地盘，我做主"><a href="#trim-我的地盘，我做主" class="headerlink" title="trim:我的地盘，我做主"></a>trim:我的地盘，我做主</h1><p>上面的where标签，其实用trim 可以表示如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"WHERE"</span> <span class="attr">prefixOverrides</span>=<span class="string">"AND |OR "</span>&gt;</span></span><br><span class="line">  ... </span><br><span class="line"><span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>它的意思就是： 当WHERE后紧随AND或则OR的时候，就去除AND或者OR。 除了WHERE以外， 其实还有一个比较经典的实现，那就是SET。</p><h1 id="set-信我，不出错"><a href="#set-信我，不出错" class="headerlink" title="set: 信我，不出错"></a>set: 信我，不出错</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;update id=<span class="string">"updateUser"</span> parameterType=<span class="string">"com.dy.entity.User"</span>&gt;</span><br><span class="line">           update user <span class="built_in">set</span> </span><br><span class="line">           &lt;<span class="keyword">if</span> <span class="built_in">test</span>=<span class="string">"name != null"</span>&gt;</span><br><span class="line">               name = <span class="comment">#&#123;name&#125;,</span></span><br><span class="line">           &lt;/<span class="keyword">if</span>&gt; </span><br><span class="line">           &lt;<span class="keyword">if</span> <span class="built_in">test</span>=<span class="string">"password != null"</span>&gt;</span><br><span class="line">               password = <span class="comment">#&#123;password&#125;,</span></span><br><span class="line">           &lt;/<span class="keyword">if</span>&gt; </span><br><span class="line">           &lt;<span class="keyword">if</span> <span class="built_in">test</span>=<span class="string">"age != null"</span>&gt;</span><br><span class="line">               age = <span class="comment">#&#123;age&#125;</span></span><br><span class="line">           &lt;/<span class="keyword">if</span>&gt; </span><br><span class="line">           &lt;<span class="built_in">where</span>&gt;</span><br><span class="line">               &lt;<span class="keyword">if</span> <span class="built_in">test</span>=<span class="string">"id != null"</span>&gt;</span><br><span class="line">                   id = <span class="comment">#&#123;id&#125;</span></span><br><span class="line">               &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">               and deleteFlag = 0;</span><br><span class="line">           &lt;/<span class="built_in">where</span>&gt;</span><br><span class="line">&lt;/update&gt;</span><br></pre></td></tr></table></figure><p>问题又来了： “如果我只有name不为null,  那么这SQL不就成了 update set name = #{name}, where …….. ?  你那name后面那逗号会导致出错啊！”</p><p>是的，这时候，就可以用mybatis为我们提供的set 标签了。下面是通过set标签改造后：<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.dy.entity.User"</span>&gt;</span></span></span><br><span class="line"><span class="xml">           update user</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name != null"</span>&gt;</span>name = #</span><span class="template-variable">&#123;name&#125;</span><span class="xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span> </span></span><br><span class="line"><span class="xml">             <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"password != null"</span>&gt;</span>password = #</span><span class="template-variable">&#123;password&#125;</span><span class="xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span> </span></span><br><span class="line"><span class="xml">             <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"age != null"</span>&gt;</span>age = #</span><span class="template-variable">&#123;age&#125;</span><span class="xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span> </span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="xml">           <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="xml">               <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"id != null"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                   id = #</span><span class="template-variable">&#123;id&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">               <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="xml">               and deleteFlag = 0;</span></span><br><span class="line"><span class="xml">           <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p><p>这个用trim 可表示为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"SET"</span> <span class="attr">suffixOverrides</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h1 id="foreach-你有for-我有foreach！"><a href="#foreach-你有for-我有foreach！" class="headerlink" title="foreach:  你有for, 我有foreach！"></a>foreach:  你有for, 我有foreach！</h1><p>java中有for, 可通过for循环， 同样， mybatis中有foreach, 可通过它实现循环，循环的对象当然主要是java容器和数组。<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">select</span> id=<span class="string">"selectPostIn"</span> resultType=<span class="string">"domain.blog.Post"</span>&gt;</span><br><span class="line">  SELECT *</span><br><span class="line">  FROM POST P</span><br><span class="line">  WHERE ID <span class="keyword">in</span></span><br><span class="line">  &lt;<span class="built_in">foreach</span> item=<span class="string">"item"</span> index=<span class="string">"index"</span> collection=<span class="string">"list"</span></span><br><span class="line">      <span class="built_in">open</span>=<span class="string">"("</span> separator=<span class="string">","</span> <span class="built_in">close</span>=<span class="string">")"</span>&gt;</span><br><span class="line">        #&#123;item&#125;</span><br><span class="line">  &lt;/<span class="built_in">foreach</span>&gt;</span><br><span class="line">&lt;/<span class="built_in">select</span>&gt;</span><br></pre></td></tr></table></figure></p><p>将一个 List 实例或者数组作为参数对象传给 MyBatis，当这么做的时候，MyBatis 会自动将它包装在一个 Map 中并以名称为键。List 实例将会以“list”作为键，而数组实例的键将是“array”。同样， 当循环的对象为map的时候，index其实就是map的key。</p><h1 id="choose-我选择了你，你选择了我"><a href="#choose-我选择了你，你选择了我" class="headerlink" title="choose: 我选择了你，你选择了我"></a>choose: 我选择了你，你选择了我</h1><p>Java中有switch,  mybatis有choose<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">select</span> id=<span class="string">"findActiveBlogLike"</span></span><br><span class="line">     resultType=<span class="string">"Blog"</span>&gt;</span><br><span class="line">  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> BLOG <span class="keyword">WHERE</span> state = ‘ACTIVE’</span><br><span class="line">  &lt;choose&gt;</span><br><span class="line">    &lt;<span class="keyword">when</span> test=<span class="string">"title != null"</span>&gt;</span><br><span class="line">      <span class="keyword">AND</span> title <span class="keyword">like</span> <span class="meta">#&#123;title&#125;</span></span><br><span class="line">    &lt;/<span class="keyword">when</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">when</span> test=<span class="string">"author != null and author.name != null"</span>&gt;</span><br><span class="line">      <span class="keyword">AND</span> author_name <span class="keyword">like</span> <span class="meta">#&#123;author.name&#125;</span></span><br><span class="line">    &lt;/<span class="keyword">when</span>&gt;</span><br><span class="line">    &lt;otherwise&gt;</span><br><span class="line">      <span class="keyword">AND</span> featured = <span class="number">1</span></span><br><span class="line">    &lt;/otherwise&gt;</span><br><span class="line">  &lt;/choose&gt;</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure></p><p>以上例子中： 当title和author都不为null的时候， 那么选择二选一（前者优先）， 如果都为null, 那么就选择 otherwise中的， 如果tilte和author只有一个不为null, 那么就选择不为null的那个。</p><p>纵观mybatis的动态SQL， 强大而简单， 相信大家简单看一下就能使用了。</p><p>好啦，本次就写到这！下篇文章将结合mybatis的源码分析一次sql语句执行的整个过程。</p><hr>]]></content:encoded>
      
      
    </item>
    
    <item>
      <title>深入浅出Mybatis系列八-mapper映射文件配置之select、resultMap</title>
      <link>https://chloneda.github.io//blog/mybatis-8/</link>
      <guid>https://chloneda.github.io//blog/mybatis-8/</guid>
      <pubDate>Sat, 16 Mar 2019 15:14:13 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;注：本文转载自&lt;a href=&quot;https://www.cnblogs.com/dongying/p/4073259.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;南轲梦&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上篇《深入浅出Mybatis系列（七）—mapper
        
      
      </description>
      
      <content:encoded><![CDATA[<p>注：本文转载自<a href="https://www.cnblogs.com/dongying/p/4073259.html" target="_blank" rel="noopener">南轲梦</a></p><p>上篇《深入浅出Mybatis系列（七）—mapper映射文件配置之insert、update、delete》介绍了insert、update、delete的用法，本篇将介绍select、resultMap的用法。select无疑是我们最常用，也是最复杂的，mybatis通过resultMap能帮助我们很好地进行高级映射。下面就开始看看select 以及 resultMap的用法：</p><p>先看select的配置吧：</p><h1 id="select配置"><a href="#select配置" class="headerlink" title="select配置"></a>select配置</h1><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">select</span></span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!--  1. id （必须配置）</span></span></span><br><span class="line"><span class="xml">        id是命名空间中的唯一标识符，可被用来代表这条语句。 </span></span><br><span class="line"><span class="xml">        一个命名空间（namespace） 对应一个dao接口, </span></span><br><span class="line"><span class="xml">        这个id也应该对应dao里面的某个方法（相当于方法的实现），因此id 应该与方法名一致  --&gt;</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     id="selectPerson"</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     <span class="comment">&lt;!-- 2. parameterType （可选配置, 默认为mybatis自动选择处理）</span></span></span><br><span class="line"><span class="xml">        将要传入语句的参数的完全限定类名或别名， 如果不配置，mybatis会通过ParameterHandler 根据参数类型默认选择合适的typeHandler进行处理</span></span><br><span class="line"><span class="xml">        parameterType 主要指定参数类型，可以是int, short, long, string等类型，也可以是复杂类型（如对象） --&gt;</span></span><br><span class="line"><span class="xml">     parameterType="int"</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     <span class="comment">&lt;!-- 3. resultType (resultType 与 resultMap 二选一配置)</span></span></span><br><span class="line"><span class="xml">         resultType用以指定返回类型，指定的类型可以是基本类型，可以是java容器，也可以是javabean --&gt;</span></span><br><span class="line"><span class="xml">     resultType="hashmap"</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     <span class="comment">&lt;!-- 4. resultMap (resultType 与 resultMap 二选一配置)</span></span></span><br><span class="line"><span class="xml">         resultMap用于引用我们通过 resultMap标签定义的映射类型，这也是mybatis组件高级复杂映射的关键 --&gt;</span></span><br><span class="line"><span class="xml">     resultMap="personResultMap"</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     <span class="comment">&lt;!-- 5. flushCache (可选配置)</span></span></span><br><span class="line"><span class="xml">         将其设置为 true，任何时候只要语句被调用，都会导致本地缓存和二级缓存都会被清空，默认值：false --&gt;</span></span><br><span class="line"><span class="xml">     flushCache="false"</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     <span class="comment">&lt;!-- 6. useCache (可选配置)</span></span></span><br><span class="line"><span class="xml">         将其设置为 true，将会导致本条语句的结果被二级缓存，默认值：对 select 元素为 true --&gt;</span></span><br><span class="line"><span class="xml">     useCache="true"</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     <span class="comment">&lt;!-- 7. timeout (可选配置) </span></span></span><br><span class="line"><span class="xml">         这个设置是在抛出异常之前，驱动程序等待数据库返回请求结果的秒数。默认值为 unset（依赖驱动）--&gt;</span></span><br><span class="line"><span class="xml">     timeout="10000"</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     <span class="comment">&lt;!-- 8. fetchSize (可选配置) </span></span></span><br><span class="line"><span class="xml">         这是尝试影响驱动程序每次批量返回的结果行数和这个设置值相等。默认值为 unset（依赖驱动)--&gt;</span></span><br><span class="line"><span class="xml">     fetchSize="256"</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     <span class="comment">&lt;!-- 9. statementType (可选配置) </span></span></span><br><span class="line"><span class="xml">         STATEMENT，PREPARED 或 CALLABLE 的一个。这会让 MyBatis 分别使用 Statement，PreparedStatement 或 CallableStatement，默认值：PREPARED--&gt;</span></span><br><span class="line"><span class="xml">     statementType="PREPARED"</span></span><br><span class="line"><span class="xml">     </span></span><br><span class="line"><span class="xml">     <span class="comment">&lt;!-- 10. resultSetType (可选配置) </span></span></span><br><span class="line"><span class="xml">         FORWARD_ONLY，SCROLL_SENSITIVE 或 SCROLL_INSENSITIVE 中的一个，默认值为 unset （依赖驱动）--&gt;</span></span><br><span class="line"><span class="xml">     resultSetType="FORWARD_ONLY"&gt;</span></span><br></pre></td></tr></table></figure><p>配置看起来总是这么多，不过实际常用的配置也就那么几个， 根据自己的需要吧，上面都已注明是否必须配置。</p><p>下面还是上个demo及时练练手吧!</p><p>数据库：新增两张表（t_course, t_student）,以下为相关实体类。</p><h1 id="Course-java"><a href="#Course-java" class="headerlink" title="Course.java"></a>Course.java</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Course</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name; </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> deleteFlag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setter和getter方法省略...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Student-java"><a href="#Student-java" class="headerlink" title="Student.java"></a>Student.java</h1><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String idCard;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">List</span>&lt;Course&gt; courseList;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> deleteFlag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setter和getter方法省略...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="CourseDao-java"><a href="#CourseDao-java" class="headerlink" title="CourseDao.java"></a>CourseDao.java</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>CourseDao &#123;</span><br><span class="line"></span><br><span class="line">    public Course findCourseById(int courseId);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="StudentDao-java"><a href="#StudentDao-java" class="headerlink" title="StudentDao.java"></a>StudentDao.java</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>StudentDao &#123;</span><br><span class="line"></span><br><span class="line">    public Student findStudentById(String idCard);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="courseDao-xml"><a href="#courseDao-xml" class="headerlink" title="courseDao.xml"></a>courseDao.xml</h1><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;mapper namespace=<span class="string">"com.dy.dao.CourseDao"</span>&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!<span class="comment">-- </span></span><br><span class="line">        <span class="number">1.</span>此处直接将resultType 设置为course, 一看就知道我设置了别名吧，如果没有设置别名，那么resultType = com.dy.entity.Course。</span><br><span class="line">         <span class="number">2.</span>可能细心的你会发现：Course.java中的属性名与数据库字段名不一致，下面，我就在sql语句中用了<span class="keyword">as</span>, 使之匹配，当然方法不止一种，</span><br><span class="line">             在学习了resultMap之后，你能看到一种更直观优雅的方式去将javabean中的属性与数据库字段名保持一致</span><br><span class="line">         <span class="number">3.</span>findCourseById 与CourseDao中findCourseById方法对应， 那么传入的参数名称以及类型也应该保持对应关系。</span><br><span class="line">         <span class="number">4.</span>可以看到，在sql语句中，通过<span class="comment">#&#123;&#125;表达式可以获取参数。</span></span><br><span class="line">         <span class="number">5.</span>下面这条sql语句，实际上的形式是怎么样的？还记得之前说过，mybatis默认为preparedStatement吧，那么，用我们jdbc代码来看，它其实就是：</span><br><span class="line">             select course_id <span class="keyword">as</span> <span class="built_in">id</span>, course_name <span class="keyword">as</span> <span class="built_in">name</span>, course_delete_flg <span class="keyword">as</span> deleteFlag <span class="keyword">from</span> t_course <span class="keyword">where</span> course_id=?</span><br><span class="line">     <span class="comment">--&gt;</span></span><br><span class="line">    &lt;select <span class="built_in">id</span>=<span class="string">"findCourseById"</span>  resultType=<span class="string">"course"</span> &gt;</span><br><span class="line">        select course_id <span class="keyword">as</span> <span class="built_in">id</span>, course_name <span class="keyword">as</span> <span class="built_in">name</span>, course_delete_flg <span class="keyword">as</span> deleteFlag <span class="keyword">from</span> t_course <span class="keyword">where</span> course_id=<span class="comment">#&#123;courseId&#125;</span></span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    </span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure><h1 id="CourseDaoTest-java"><a href="#CourseDaoTest-java" class="headerlink" title="CourseDaoTest.java"></a>CourseDaoTest.java</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseDaoTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findCourseById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SqlSessionFactory sqlSessionFactory = getSessionFactory();</span><br><span class="line">        SqlSession sqlSession = sqlSessionFactory.openSession(); </span><br><span class="line">        CourseDao courseDao = sqlSession.getMapper(CourseDao.class);</span><br><span class="line">        Course course = courseDao.findCourseById(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Mybatis 通过SqlSessionFactory获取SqlSession, 然后才能通过SqlSession与数据库进行交互</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">getSessionFactory</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        SqlSessionFactory sessionFactory = <span class="keyword">null</span>;  </span><br><span class="line">        String resource = <span class="string">"mybatis-conf.xml"</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(Resources  </span><br><span class="line">                    .getResourceAsReader(resource));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> sessionFactory;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的示例，我们针对course, 简单演示了 select的用法， 不过有个问题值得思考： 一个student可以对应多个course,  那么，在mybatis中如何处理这种一对多， 甚至于多对多，一对一的关系呢？</p><p>这儿，就不得不提到 resultMap 这个东西， mybatis的resultMap功能可谓十分强大，能够处理复杂的关系映射， 那么resultMap 该怎么配置呢？ 别急，这就来了：</p><h1 id="resultMap配置"><a href="#resultMap配置" class="headerlink" title="resultMap配置"></a>resultMap配置</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">        1.type 对应类型，可以是javabean, 也可以是其它</span></span><br><span class="line"><span class="comment">        2.id 必须唯一， 用于标示这个resultMap的唯一性，在使用resultMap的时候，就是通过id指定</span></span><br><span class="line"><span class="comment">     --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">""</span> <span class="attr">id</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">&lt;!-- id, 唯一性，注意啦，这个id用于标示这个javabean对象的唯一性， 不一定会是数据库的主键（不要把它理解为数据库对应表的主键） </span></span><br><span class="line"><span class="comment">            property属性对应javabean的属性名，column对应数据库表的列名</span></span><br><span class="line"><span class="comment">            （这样，当javabean的属性与数据库对应表的列名不一致的时候，就能通过指定这个保持正常映射了）</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">""</span> <span class="attr">column</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- result与id相比， 对应普通属性 --&gt;</span>    </span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">""</span> <span class="attr">column</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">            constructor对应javabean中的构造方法</span></span><br><span class="line"><span class="comment">         --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- idArg 对应构造方法中的id参数 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">idArg</span> <span class="attr">column</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- arg 对应构造方法中的普通参数 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg</span> <span class="attr">column</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">constructor</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">            collection，对应javabean中容器类型, 是实现一对多的关键 </span></span><br><span class="line"><span class="comment">            property 为javabean中容器对应字段名</span></span><br><span class="line"><span class="comment">            column 为体现在数据库中列名</span></span><br><span class="line"><span class="comment">            ofType 就是指定javabean中容器指定的类型</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">""</span> <span class="attr">column</span>=<span class="string">""</span> <span class="attr">ofType</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">            association 为关联关系，是实现N对一的关键。</span></span><br><span class="line"><span class="comment">            property 为javabean中容器对应字段名</span></span><br><span class="line"><span class="comment">            column 为体现在数据库中列名</span></span><br><span class="line"><span class="comment">            javaType 指定关联的类型</span></span><br><span class="line"><span class="comment">         --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">""</span> <span class="attr">column</span>=<span class="string">""</span> <span class="attr">javaType</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure><p>好啦，知道resutMap怎么配置后，咱们立即接着上面的demo来练习一下吧：</p><p><strong>下面是用resultMap处理一对多关系的映射的示例</strong></p><p>一个student对应多个course， 典型的一对多，咱们就来看看mybatis怎么配置这种映射吧：</p><h1 id="studentDao-xml"><a href="#studentDao-xml" class="headerlink" title="studentDao.xml"></a>studentDao.xml</h1><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.dy.dao.StudentDao"</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 这儿定义一个resultMap --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">type</span>=<span class="string">"student"</span> <span class="attr">id</span>=<span class="string">"studentMap"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- </span></span></span><br><span class="line"><span class="xml">            数据库中主键是id, 但是我这儿却是指定idCard为主键，为什么？ </span></span><br><span class="line"><span class="xml">            刚刚讲了，id用来表示唯一性， 我们可以认为只要idCard一样，那么他就是同一个学生。</span></span><br><span class="line"><span class="xml">            如果此处用数据库中id， 那么mybatis将会认为数据库中每条记录都是一个student, 这显然不符合逻辑</span></span><br><span class="line"><span class="xml">        --&gt;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"idCard"</span> <span class="attr">column</span>=<span class="string">"stu_id_card"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"stu_id"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"stu_name"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"deleteFlag"</span> <span class="attr">column</span>=<span class="string">"stu_delete_flg"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        </span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- </span></span></span><br><span class="line"><span class="xml">            这儿就是实现一对多的关键。 </span></span><br><span class="line"><span class="xml">            在Student中，courseList为List<span class="tag">&lt;<span class="name">Course</span>&gt;</span>, 因此，ofType也应该与之对应（当然，我用了别名，不然要蛋疼的写全名了）。</span></span><br><span class="line"><span class="xml">            collection的子标签是在指定Course的映射关系（由于Course的javabean的属性名与数据库的列名不一致）</span></span><br><span class="line"><span class="xml">        --&gt;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"courseList"</span> <span class="attr">column</span>=<span class="string">"stu_course_id"</span> <span class="attr">ofType</span>=<span class="string">"Course"</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"course_id"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"course_name"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"deleteFlag"</span> <span class="attr">column</span>=<span class="string">"course_delete_flg"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- 这儿将返回类型设置成了上面指定的studentMap --&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findStudentById"</span> <span class="attr">resultMap</span>=<span class="string">"studentMap"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        SELECT s.*, c.* FROM t_student s LEFT JOIN t_course c ON s.stu_course_id=c.course_id WHERE s.stu_id_card=#</span><span class="template-variable">&#123;idCard&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h1 id="StudentDaoTest-java"><a href="#StudentDaoTest-java" class="headerlink" title="StudentDaoTest.java"></a>StudentDaoTest.java</h1><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentDaoTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findCourseById</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        SqlSessionFactory sqlSessionFactory = getSessionFactory();</span><br><span class="line">        SqlSession sqlSession = sqlSessionFactory.openSession(); </span><br><span class="line">        StudentDao studentDao = sqlSession.getMapper(StudentDao.class);</span><br><span class="line">        Student student = studentDao.findStudentById(<span class="string">"20140101"</span>);</span><br><span class="line">        List&lt;Course&gt; courseList = student.getCourseList();</span><br><span class="line">        <span class="keyword">for</span> (Course course: courseList) &#123;</span><br><span class="line">            System.<span class="keyword">out</span>.println(course.getId() + <span class="string">"   "</span> + course.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Mybatis 通过SqlSessionFactory获取SqlSession, 然后才能通过SqlSession与数据库进行交互</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">getSessionFactory</span>(<span class="params"></span>)</span> &#123;  </span><br><span class="line">        SqlSessionFactory sessionFactory = <span class="literal">null</span>;  </span><br><span class="line">        String resource = <span class="string">"mybatis-conf.xml"</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            sessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(Resources  </span><br><span class="line">                    .getResourceAsReader(resource));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> sessionFactory;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>相信通过以上demo， 大家也能够使用mybatis的select 和 resultMap的用法了。上面demo只演示了一对多的映射，其实多对一、多对多也与它类似，所以我就没演示了，有兴趣的可以自己动手再做做。</p><hr>]]></content:encoded>
      
      
    </item>
    
    <item>
      <title>深入浅出Mybatis系列七-mapper映射文件配置之insert、update、delete</title>
      <link>https://chloneda.github.io//blog/mybatis-7/</link>
      <guid>https://chloneda.github.io//blog/mybatis-7/</guid>
      <pubDate>Sat, 16 Mar 2019 15:00:03 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;注：本文转载自&lt;a href=&quot;https://www.cnblogs.com/dongying/p/4048828.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;南轲梦&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上篇文章《深入浅出Mybatis系列（六）—obje
        
      
      </description>
      
      <content:encoded><![CDATA[<p>注：本文转载自<a href="https://www.cnblogs.com/dongying/p/4048828.html" target="_blank" rel="noopener">南轲梦</a></p><p>上篇文章《深入浅出Mybatis系列（六）—objectFactory、plugins、mappers简介与配置》简单地给mybatis的配置画上了一个句号。那么从本篇文章开始，将会介绍mapper映射文件的配置， 这是mybatis的核心之一，一定要学好。在mapper文件中，以mapper作为根节点，其下面可以配置的元素节点有： select, insert, update, delete, cache, cache-ref, resultMap, sql 。</p><p>本篇文章将简单介绍 insert, update, delete 的配置及使用，以后会对mybatis的源码进行深入讲解。</p><p>相信，看到insert, update, delete， 我们就知道其作用了，顾名思义嘛，myabtis 作为持久层框架，必须要对CRUD啊。</p><p>好啦，咱们就先来看看 insert, update, delete 怎么配置， 能配置哪些元素吧：</p><p>相关元素配置<br><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>   </span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE mapper   </span></span></span><br><span class="line"><span class="xml">PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"  </span></span><br><span class="line"><span class="xml">"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd"&gt; </span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="comment">&lt;!-- mapper 为根元素节点， 一个namespace对应一个dao --&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.dy.dao.UserDao"</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">insert</span></span></span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 1. id （必须配置）</span></span></span><br><span class="line"><span class="xml">        id是命名空间中的唯一标识符，可被用来代表这条语句。 </span></span><br><span class="line"><span class="xml">        一个命名空间（namespace） 对应一个dao接口, </span></span><br><span class="line"><span class="xml">        这个id也应该对应dao里面的某个方法（相当于方法的实现），因此id 应该与方法名一致 --&gt;</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      id="insertUser"</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 2. parameterType （可选配置, 默认为mybatis自动选择处理）</span></span></span><br><span class="line"><span class="xml">        将要传入语句的参数的完全限定类名或别名， 如果不配置，mybatis会通过ParameterHandler 根据参数类型默认选择合适的typeHandler进行处理</span></span><br><span class="line"><span class="xml">        parameterType 主要指定参数类型，可以是int, short, long, string等类型，也可以是复杂类型（如对象） --&gt;</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      parameterType="com.demo.User"</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 3. flushCache （可选配置，默认配置为true）</span></span></span><br><span class="line"><span class="xml">        将其设置为 true，任何时候只要语句被调用，都会导致本地缓存和二级缓存都会被清空，默认值：true（对应插入、更新和删除语句） --&gt;</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      flushCache="true"</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 4. statementType （可选配置，默认配置为PREPARED）</span></span></span><br><span class="line"><span class="xml">        STATEMENT，PREPARED 或 CALLABLE 的一个。这会让 MyBatis 分别使用 Statement，PreparedStatement 或 CallableStatement，默认值：PREPARED。 --&gt;</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      statementType="PREPARED"</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 5. keyProperty (可选配置， 默认为unset)</span></span></span><br><span class="line"><span class="xml">        （仅对 insert 和 update 有用）唯一标记一个属性，MyBatis 会通过 getGeneratedKeys 的返回值或者通过 insert 语句的 selectKey 子元素设置它的键值，默认：unset。如果希望得到多个生成的列，也可以是逗号分隔的属性名称列表。 --&gt;</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      keyProperty=""</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 6. keyColumn     (可选配置)</span></span></span><br><span class="line"><span class="xml">        （仅对 insert 和 update 有用）通过生成的键值设置表中的列名，这个设置仅在某些数据库（像 PostgreSQL）是必须的，当主键列不是表中的第一列的时候需要设置。如果希望得到多个生成的列，也可以是逗号分隔的属性名称列表。 --&gt;</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      keyColumn=""</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 7. useGeneratedKeys (可选配置， 默认为false)</span></span></span><br><span class="line"><span class="xml">        （仅对 insert 和 update 有用）这会令 MyBatis 使用 JDBC 的 getGeneratedKeys 方法来取出由数据库内部生成的主键（比如：像 MySQL 和 SQL Server 这样的关系数据库管理系统的自动递增字段），默认值：false。  --&gt;</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      useGeneratedKeys="false"</span></span><br><span class="line"><span class="xml">      </span></span><br><span class="line"><span class="xml">      <span class="comment">&lt;!-- 8. timeout  (可选配置， 默认为unset, 依赖驱动)</span></span></span><br><span class="line"><span class="xml">        这个设置是在抛出异常之前，驱动程序等待数据库返回请求结果的秒数。默认值为 unset（依赖驱动）。 --&gt;</span></span><br><span class="line"><span class="xml">      timeout="20"&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">update</span></span></span></span><br><span class="line"><span class="xml">      id="updateUser"</span></span><br><span class="line"><span class="xml">      parameterType="com.demo.User"</span></span><br><span class="line"><span class="xml">      flushCache="true"</span></span><br><span class="line"><span class="xml">      statementType="PREPARED"</span></span><br><span class="line"><span class="xml">      timeout="20"&gt;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">delete</span></span></span></span><br><span class="line"><span class="xml">      id="deleteUser"</span></span><br><span class="line"><span class="xml">      parameterType="com.demo.User"</span></span><br><span class="line"><span class="xml">      flushCache="true"</span></span><br><span class="line"><span class="xml">      statementType="PREPARED"</span></span><br><span class="line"><span class="xml">      timeout="20"&gt;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p><p>以上就是一个模板配置， 哪些是必要配置，哪些是根据自己实际需求，看一眼就知道了。</p><p>下面， 还是用第一篇文章《深入浅出Mybatis系列（一）—Mybatis入门》里面的demo来示例吧：</p><h1 id="User类"><a href="#User类" class="headerlink" title="User类"></a>User类</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> deleteFlag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setter和getter方法省略...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="UserDao类"><a href="#UserDao类" class="headerlink" title="UserDao类"></a>UserDao类</h1><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">UserDao</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertUser</span> (<span class="params">User user</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span> (<span class="params">User user</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span> (<span class="params">User user</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="userDao-xml"><a href="#userDao-xml" class="headerlink" title="userDao.xml"></a>userDao.xml</h1><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>   </span></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE mapper   </span></span></span><br><span class="line"><span class="xml">PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"  </span></span><br><span class="line"><span class="xml">"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd"&gt; </span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.dy.dao.UserDao"</span>&gt;</span></span></span><br><span class="line"><span class="xml">   </span></span><br><span class="line"><span class="xml">   <span class="comment">&lt;!-- 对应userDao中的insertUser方法，  --&gt;</span></span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.dy.entity.User"</span>&gt;</span></span></span><br><span class="line"><span class="xml">           insert into user(id, name, password, age, deleteFlag) </span></span><br><span class="line"><span class="xml">               values(#</span><span class="template-variable">&#123;id&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;name&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;password&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;age&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;deleteFlag&#125;</span><span class="xml">)</span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span></span><br><span class="line"><span class="xml">   </span></span><br><span class="line"><span class="xml">   <span class="comment">&lt;!-- 对应userDao中的updateUser方法 --&gt;</span></span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.dy.entity.User"</span>&gt;</span></span></span><br><span class="line"><span class="xml">           update user set name = #</span><span class="template-variable">&#123;name&#125;</span><span class="xml">, password = #</span><span class="template-variable">&#123;password&#125;</span><span class="xml">, age = #</span><span class="template-variable">&#123;age&#125;</span><span class="xml">, deleteFlag = #</span><span class="template-variable">&#123;deleteFlag&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">               where id = #</span><span class="template-variable">&#123;id&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">   <span class="comment">&lt;!-- 对应userDao中的deleteUser 方法 --&gt;</span> </span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.dy.entity.User"</span>&gt;</span></span></span><br><span class="line"><span class="xml">           delete from user where id = #</span><span class="template-variable">&#123;id&#125;</span><span class="xml">;</span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>这样，一个简单的映射关系就建立了。仔细观察上面parameterType,  “com.dy.entity.User”，包名要是再长点呢，每次都这样写，写得蛋疼了。别忘了之前讲的 typeAliases（别名）， 那么这个地方，用上别名，岂不是技能跟蛋疼的长长的包名说拜拜了。好啦，咱们配上别名，在哪儿配？ 当然是在mybatis 的全局配置文件（我这儿名字是mybatis-conf.xml）， 不要认为是在mapper的配置文件里面配置哈。</p><h1 id="mybatis-conf-xml"><a href="#mybatis-conf-xml" class="headerlink" title="mybatis-conf.xml"></a>mybatis-conf.xml</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">      通过package, 可以直接指定package的名字， mybatis会自动扫描你指定包下面的javabean,</span></span><br><span class="line"><span class="comment">      并且默认设置一个别名，默认的名字为： javabean 的首字母小写的非限定类名来作为它的别名。</span></span><br><span class="line"><span class="comment">      也可在javabean 加上注解@Alias 来自定义别名， 例如： @Alias(user) </span></span><br><span class="line"><span class="comment">      &lt;package name="com.dy.entity"/&gt;</span></span><br><span class="line"><span class="comment">       --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.dy.entity.User"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这样，一个别名就取好了，咱们可以把上面的 com.dy.entity.User 都直接改为user 了。 这多方便呀！</p><p>我这儿数据库用的是mysql, 我把user表的主键id 设置了自动增长， 以上代码运行正常， 那么问题来了（当然，我不是要问学挖掘机哪家强），我要是换成oracle数据库怎么办？ oracle 可是不支持id自增长啊？ 怎么办？请看下面：<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!-- 对应userDao中的insertUser方法，  --&gt;</span></span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.dy.entity.User"</span>&gt;</span></span></span><br><span class="line"><span class="xml">           <span class="comment">&lt;!-- oracle等不支持id自增长的，可根据其id生成策略，先获取id </span></span></span><br><span class="line"><span class="xml">           </span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">resultType</span>=<span class="string">"int"</span> <span class="attr">order</span>=<span class="string">"BEFORE"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span></span><br><span class="line"><span class="xml">              select seq_user_id.nextval as id from dual</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span></span><br><span class="line"><span class="xml">        --&gt;   </span></span><br><span class="line"><span class="xml">           insert into user(id, name, password, age, deleteFlag) </span></span><br><span class="line"><span class="xml">               values(#</span><span class="template-variable">&#123;id&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;name&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;password&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;age&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;deleteFlag&#125;</span><span class="xml">)</span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p><p>同理，如果我们在使用mysql的时候，想在数据插入后返回插入的id, 我们也可以使用 selectKey 这个元素：<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="comment">&lt;!-- 对应userDao中的insertUser方法，  --&gt;</span></span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertUser"</span> <span class="attr">parameterType</span>=<span class="string">"com.dy.entity.User"</span>&gt;</span></span></span><br><span class="line"><span class="xml">           <span class="comment">&lt;!-- oracle等不支持id自增长的，可根据其id生成策略，先获取id </span></span></span><br><span class="line"><span class="xml">           </span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">resultType</span>=<span class="string">"int"</span> <span class="attr">order</span>=<span class="string">"BEFORE"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span></span><br><span class="line"><span class="xml">              select seq_user_id.nextval as id from dual</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span></span><br><span class="line"><span class="xml">        </span></span><br><span class="line"><span class="xml">        --&gt; </span></span><br><span class="line"><span class="xml">        </span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- mysql插入数据后，获取id --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">resultType</span>=<span class="string">"int"</span> <span class="attr">order</span>=<span class="string">"AFTER"</span> &gt;</span></span></span><br><span class="line"><span class="xml">               SELECT LAST_INSERT_ID() as id</span></span><br><span class="line"><span class="xml">           <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span></span><br><span class="line"><span class="xml">          </span></span><br><span class="line"><span class="xml">           insert into user(id, name, password, age, deleteFlag) </span></span><br><span class="line"><span class="xml">               values(#</span><span class="template-variable">&#123;id&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;name&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;password&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;age&#125;</span><span class="xml">, #</span><span class="template-variable">&#123;deleteFlag&#125;</span><span class="xml">)</span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p><p>这儿，我们就简单提一下 <selectkey> 这个元素节点吧:<br><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">selectKey</span></span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- selectKey 语句结果应该被设置的目标属性。如果希望得到多个生成的列，也可以是逗号分隔的属性名称列表。 --&gt;</span></span></span><br><span class="line"><span class="xml">        keyProperty="id"</span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 结果的类型。MyBatis 通常可以推算出来，但是为了更加确定写上也不会有什么问题。MyBatis 允许任何简单类型用作主键的类型，包括字符串。如果希望作用于多个生成的列，则可以使用一个包含期望属性的 Object 或一个 Map。 --&gt;</span></span></span><br><span class="line"><span class="xml">        resultType="int"</span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 这可以被设置为 BEFORE 或 AFTER。如果设置为 BEFORE，那么它会首先选择主键，设置 keyProperty 然后执行插入语句。如果设置为 AFTER，那么先执行插入语句，然后是 selectKey 元素 - 这和像 Oracle 的数据库相似，在插入语句内部可能有嵌入索引调用。 --&gt;</span></span></span><br><span class="line"><span class="xml">        order="BEFORE"</span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 与前面相同，MyBatis 支持 STATEMENT，PREPARED 和 CALLABLE 语句的映射类型，分别代表 PreparedStatement 和 CallableStatement 类型。 --&gt;</span></span></span><br><span class="line"><span class="xml">        statementType="PREPARED"&gt;</span></span><br></pre></td></tr></table></figure></selectkey></p><p>好啦，本篇文章主要介绍了insert, update, delete的配置及用法。 下篇文章将介绍复杂的 select相关的配置及用法， 待这些都讲完后，会先根据源码分析一下mybatis的整个运行流程，然后再深入mybatis的用法。</p><hr>]]></content:encoded>
      
      
    </item>
    
    <item>
      <title>深入浅出Mybatis系列六-objectFactory、plugins、mappers简介与配置</title>
      <link>https://chloneda.github.io//blog/mybatis-6/</link>
      <guid>https://chloneda.github.io//blog/mybatis-6/</guid>
      <pubDate>Sat, 16 Mar 2019 14:49:42 GMT</pubDate>
      <description>
      
        
        
          &lt;p&gt;注：本文转载自&lt;a href=&quot;https://www.cnblogs.com/dongying/p/4046488.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;南轲梦&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上篇文章《深入浅出Mybatis系列（五）—Type
        
      
      </description>
      
      <content:encoded><![CDATA[<p>注：本文转载自<a href="https://www.cnblogs.com/dongying/p/4046488.html" target="_blank" rel="noopener">南轲梦</a></p><p>上篇文章《深入浅出Mybatis系列（五）—TypeHandler简介及配置（mybatis源码篇）》简单看了一下TypeHandler， 本次将结束对于mybatis的配置文件的学习， 本次涉及到剩下没提及到的几个节点的配置：objectFactory、databaseIdProvider、plugins、mappers。</p><p>那么，接下来，就简单介绍一下这几个配置的作用吧：</p><p>1、objectFactory是干什么的？ 需要配置吗？</p><p>MyBatis 每次创建结果对象的新实例时，它都会使用一个对象工厂（ObjectFactory）实例来完成。默认的对象工厂需要做的仅仅是实例化目标类，要么通过默认构造方法，要么在参数映射存在的时候通过参数构造方法来实例化。默认情况下，我们不需要配置，mybatis会调用默认实现的objectFactory。 除非我们要自定义ObjectFactory的实现， 那么我们才需要去手动配置。</p><p>那么怎么自定义实现ObjectFactory？ 怎么配置呢？</p><p>自定义ObjectFactory只需要去继承DefaultObjectFactory（是ObjectFactory接口的实现类），并重写其方法即可。具体的，本处不多说，后面再具体讲解。</p><p>写好了ObjectFactory, 仅需做如下配置：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    <span class="params">...</span><span class="params">...</span></span><br><span class="line">    &lt;objectFactory <span class="keyword">type</span>=<span class="string">"org.mybatis.example.ExampleObjectFactory"</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">"someProperty"</span> value=<span class="string">"100"</span>/&gt;</span><br><span class="line">    &lt;/objectFactory&gt;</span><br><span class="line">    <span class="params">...</span><span class="params">...</span></span><br><span class="line">  &lt;/configuration</span><br></pre></td></tr></table></figure></p><p>plugin有何作用？ 需要配置吗？</p><p>plugins 是一个可选配置。mybatis中的plugin其实就是个interceptor， 它可以拦截Executor 、ParameterHandler 、ResultSetHandler 、StatementHandler 的部分方法，处理我们自己的逻辑。Executor就是真正执行sql语句的东西， ParameterHandler 是处理我们传入参数的，还记得前面讲TypeHandler的时候提到过，mybatis默认帮我们实现了不少的typeHandler, 当我们不显示配置typeHandler的时候，mybatis会根据参数类型自动选择合适的typeHandler执行，其实就是ParameterHandler 在选择。ResultSetHandler 就是处理返回结果的。</p><p>怎么自定义plugin? 怎么配置？</p><p>要自定义一个plugin, 需要去实现Interceptor接口， 这儿不细说， 后面实战部分会详细讲解。定义好之后，配置如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"org.mybatis.example.ExamplePlugin"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"someProperty"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    ......</span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>mappers, 这下引出mybatis的核心之一了，mappers作用 ? 需要配置吗？</p><p>mappers 节点下，配置我们的mapper映射文件， 所谓的mapper映射文件，就是让mybatis 用来建立数据表和javabean映射的一个桥梁。在我们实际开发中，通常一个mapper文件对应一个dao接口， 这个mapper可以看做是dao的实现。所以,mappers必须配置。</p><p>那么怎么配置呢？<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 第一种方式：通过resource指定 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"com/dy/dao/userDao.xml"</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">     <span class="comment">&lt;!-- 第二种方式， 通过class指定接口，进而将接口与对应的xml文件形成映射关系</span></span><br><span class="line"><span class="comment">             不过，使用这种方式必须保证 接口与mapper文件同名(不区分大小写)， </span></span><br><span class="line"><span class="comment">             我这儿接口是UserDao,那么意味着mapper文件为UserDao.xml </span></span><br><span class="line"><span class="comment">     &lt;mapper class="com.dy.dao.UserDao"/&gt;</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">&lt;!-- 第三种方式，直接指定包，自动扫描，与方法二同理 </span></span><br><span class="line"><span class="comment">      &lt;package name="com.dy.dao"/&gt;</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 第四种方式：通过url指定mapper文件位置</span></span><br><span class="line"><span class="comment">      &lt;mapper url="file://........"/&gt;</span></span><br><span class="line"><span class="comment">       --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line">    ......</span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>本篇仅作简单介绍， 更高级的使用以及其实现原理，会在后面的实战部分进行详细讲解。</p><p>这几个节点的解析源码，与之前提到的那些节点的解析类似，源码需要的可以从这里看看。</p><h1 id="相关节点源码"><a href="#相关节点源码" class="headerlink" title="相关节点源码"></a>相关节点源码</h1><figure class="highlight qml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * objectFactory 节点解析</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">private <span class="keyword">void</span> objectFactoryElement(XNode context) throws <span class="title">Exception</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">//读取type属性的值， 接下来进行实例化ObjectFactory, 并set进 configuration</span></span><br><span class="line">      <span class="comment">//到此，简单讲一下configuration这个对象，其实它里面主要保存的都是mybatis的配置</span></span><br><span class="line">      <span class="built_in">String</span> type = context.getStringAttribute(<span class="string">"type"</span>);</span><br><span class="line">      <span class="comment">//读取propertie的值， 根据需要可以配置， mybatis默认实现的objectFactory没有使用properties</span></span><br><span class="line">      Properties properties = context.getChildrenAsProperties();</span><br><span class="line">      </span><br><span class="line">      ObjectFactory factory = (ObjectFactory) resolveClass(type).newInstance();</span><br><span class="line">      factory.setProperties(properties);</span><br><span class="line">      configuration.setObjectFactory(factory);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * plugins 节点解析</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  private <span class="keyword">void</span> pluginElement(XNode <span class="built_in">parent</span>) throws <span class="title">Exception</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">parent</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (XNode <span class="attribute">child</span> : <span class="built_in">parent</span>.getChildren()) &#123;</span><br><span class="line">        <span class="built_in">String</span> interceptor = child.getStringAttribute(<span class="string">"interceptor"</span>);</span><br><span class="line">        Properties properties = child.getChildrenAsProperties();</span><br><span class="line">        <span class="comment">//由此可见，我们在定义一个interceptor的时候，需要去实现Interceptor, 这儿先不具体讲，以后会详细讲解</span></span><br><span class="line">        Interceptor interceptorInstance = (Interceptor) resolveClass(interceptor).newInstance();</span><br><span class="line">        interceptorInstance.setProperties(properties);</span><br><span class="line">        configuration.addInterceptor(interceptorInstance);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * mappers 节点解析</span></span><br><span class="line"><span class="comment">   * 这是mybatis的核心之一，这儿先简单介绍，在接下来的文章会对它进行分析</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  private <span class="keyword">void</span> mapperElement(XNode <span class="built_in">parent</span>) throws <span class="title">Exception</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">parent</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (XNode <span class="attribute">child</span> : <span class="built_in">parent</span>.getChildren()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"package"</span>.equals(child.getName())) &#123;</span><br><span class="line">          <span class="comment">//如果mappers节点的子节点是package, 那么就扫描package下的文件, 注入进configuration</span></span><br><span class="line">          <span class="built_in">String</span> mapperPackage = child.getStringAttribute(<span class="string">"name"</span>);</span><br><span class="line">          configuration.addMappers(mapperPackage);</span><br><span class="line">        &#125; <span class="title">else</span> &#123;</span><br><span class="line">          <span class="built_in">String</span> resource = child.getStringAttribute(<span class="string">"resource"</span>);</span><br><span class="line">          <span class="built_in">String</span> <span class="built_in">url</span> = child.getStringAttribute(<span class="string">"url"</span>);</span><br><span class="line">          <span class="built_in">String</span> mapperClass = child.getStringAttribute(<span class="string">"class"</span>);</span><br><span class="line">          <span class="comment">//resource, url, class 三选一</span></span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (resource != <span class="literal">null</span> &amp;&amp; <span class="built_in">url</span> == <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">            ErrorContext.instance().resource(resource);</span><br><span class="line">            InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">            <span class="comment">//mapper映射文件都是通过XMLMapperBuilder解析</span></span><br><span class="line">            XMLMapperBuilder mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, resource, configuration.getSqlFragments());</span><br><span class="line">            mapperParser.parse();</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; <span class="built_in">url</span> != <span class="literal">null</span> &amp;&amp; mapperClass == <span class="literal">null</span>) &#123;</span><br><span class="line">            ErrorContext.instance().resource(<span class="built_in">url</span>);</span><br><span class="line">            InputStream inputStream = Resources.getUrlAsStream(<span class="built_in">url</span>);</span><br><span class="line">            XMLMapperBuilder mapperParser = <span class="keyword">new</span> XMLMapperBuilder(inputStream, configuration, <span class="built_in">url</span>, configuration.getSqlFragments());</span><br><span class="line">            mapperParser.parse();</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resource == <span class="literal">null</span> &amp;&amp; <span class="built_in">url</span> == <span class="literal">null</span> &amp;&amp; mapperClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);</span><br><span class="line">            configuration.addMapper(mapperInterface);</span><br><span class="line">          &#125; <span class="title">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"A mapper element may only specify a url, resource or class, but not more than one."</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>本次就简单的到此结束， 从下篇文章开始，将会开始接触到mybatis的核心部分，不过首先还是要讲mapper文件的配置及使用， 并通过源码进一步深入核心。</p><hr>]]></content:encoded>
      
      
    </item>
    
  </channel>
</rss>
